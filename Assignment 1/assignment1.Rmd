---
title: "Asssignment 1"
author: "Nigel"
date: '2022-09-04'
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(GGally)
library(zoo)
library(rpart)
library(rpart.plot)
library(Metrics)
```

## Data

```{r import data, include=FALSE}
weather_data <- read.csv("weather_data.csv", sep = ",")
sales_data <- read.csv("sales_data.csv", sep = ",")
```

### 1. Describe your data visually and numerically
Both data sets contained mixed variables.

The weather data set consists of 422 observations and 22 variables. This data set records daily weather conditions including temperature, wind, humidity, rainfall, etc.

```{r dimensions_weather, echo=TRUE}
dim(weather_data)
```

The sales data set consists of 414 observations and 9 variables. This data set records daily sales and details the source of sales including UberEats, Menulog, Deliveroo sales, and cash and eftpos sales. 

```{r dimensions_sales, echo=TRUE}
dim(sales_data)
```

### 2. Provide details of the pre-processing undertaken in order to meet the conditions of your chosen modelling techniques.
The variable names given to the weather data were renamed to aid in pre-processing. 

```{r rename_weather, echo=FALSE}
colnames(weather_data) <- c("date", "min_temp", "max_temp", "rainfall", "evap", 
                            "sun_sh_hr", "dir_max_wind", "spd_max_wind", "tm_max_wind", 
                            "9am_temp", "9am_hum", "9am_cld_amnt", "9am_wind_dir", "9am_wind_spd", "9am_pres",
                            "3pm_temp", "3pm_hum", "3pm_cld_amnt", "3pm_wind_dir", "3pm_wind_spd", "3pm_pres",
                            "rain_today", "rain_tmrw")
```

The weather data set contained very few NA values. 

```{r NAs_weather, echo=FALSE}
colSums(is.na(weather_data))
```

We decided to resolve these NA values by imputing the monthly means for each year. To do this we created a "month" and "year" variable by extracting the values from the "date" variable. 

```{r feature_creation_date_weather, echo=FALSE}
# Format "Date" columns
weather_data$date <- as.Date(weather_data$date, format = "%d/%m/%Y")
weather_data <- weather_data[order(as.Date(weather_data$date, format = "%d/%m/%Y")), ]

# Create "month", "year", and "year_month" variable
weather_data$month <- months(as.POSIXlt(weather_data$date, format = "%Y-%m-%d"))
weather_data$year <- year(as.POSIXlt(weather_data$date, format = "%Y-%m-%d"))
```

```{r impute_weather, echo=FALSE}
weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(max_temp = ifelse(is.na(max_temp),
                                                         mean(max_temp, na.rm = TRUE), max_temp)))

weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(rainfall = ifelse(is.na(rainfall),
                                                         mean(rainfall, na.rm = TRUE), rainfall)))

weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(sun_sh_hr = ifelse(is.na(sun_sh_hr),
                                                         mean(rainfall, na.rm = TRUE), sun_sh_hr)))

weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(spd_max_wind = ifelse(is.na(spd_max_wind),
                                                         mean(spd_max_wind, na.rm = TRUE), spd_max_wind)))

weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(`9am_hum` = ifelse(is.na(`9am_hum`),
                                                         mean(`9am_hum`, na.rm = TRUE), `9am_hum`)))

weather_data <- as.data.frame(weather_data %>% group_by(year, month) %>%
                                mutate(`9am_cld_amnt` = ifelse(is.na(`9am_cld_amnt`),
                                                          mean(`9am_cld_amnt`, na.rm = TRUE), `9am_cld_amnt`)))
```

The eight most recent observations were removed as the sales data set only records data eight days prior to the weather data set.

```{r remove_observations, echo=FALSE}
# Remove rows from "weather_data" so number of rows is equivalent 
weather_data <- weather_data[-c(1:8), ]
```

Two separate .csv files were used to create the sales data set. One recorded sales data for 2021 and the other for 2022. The 2022 file contained an extra variable recording eftpos sales including the surcharge. This variable was the “Card” variable multiplied by the surcharge (1.011%). This variable was removed as it was deemed unnecessary. 

```{r removed_column, echo=FALSE}
sales_data <- subset(sales_data, select = -c(X))
```

Next, the variable names were renamed to keep consistency during pre-processing.

```{r rename_sales, echo=FALSE}
colnames(sales_data) <- c("date", "day", "ubereats", "menulog", "deliveroo", "card", "cash", "total", "petty_cash")
```

We also created a “month” and “year” variable for this data set using the same method as the weather data set.

```{r feature_creation, echo=FALSE}
sales_data$date <- as.Date(sales_data$date, format = "%d/%m/%Y")

sales_data$month <- months(as.POSIXlt(sales_data$date, format = "%Y-%m-%d"))
sales_data$year <- year(as.POSIXlt(sales_data$date, format = "%Y-%m-%d"))
```

The sales data contained numerous NA values. 

```{r NAs_sales, echo=FALSE}
colSums(is.na(sales_data))
```

The majority of these NAs occurred in the “uber”, “menulog”, and “deliveroo” variables. These NAs exist due to the restaurant being closed during the COVID-19 lockdown so it makes sense to replace them with 0.

```{r replace_NA, echo=FALSE}
sales_data[is.na(sales_data)] <- 0
```

For both data sets, a “yr_month” variable - in the format “Jan 2000” - was created to allow the creation of time-series graphs.

```{r create_yr_month, echo=FALSE}
weather_data$yr_month <- as.yearmon(weather_data$date)
sales_data$yr_month <- as.yearmon(sales_data$date)

# Remove rows from "weather_data" so number of rows is equivalent 
weather_data <- subset(weather_data, date > as.Date("2021-09-26"))
weather_data <- subset(weather_data, date < as.Date("2022-08-19"))
```

Next we combine the two datasets so that we can create a correlation matrix to determine the significant variables for our chosen models. The “uber”, “menulog”, “deliveroo”, and “total” variables were appended to the weather data to create a master data frame. Next, the “rain_today” and “rain_tmrw” variables were modified to contain binary values. Then we removed the observations where total sales equals zero. Finally, we created a subset of the master data frame containing only numeric variables to allow for the creation of the correlation matrix.

```{r master_df, echo=FALSE}
master_df <- cbind(weather_data, sales_data)
master_df$rain_today <- ifelse(master_df$rain_today == "Yes", 1, 0)
master_df$rain_tmrw <- ifelse(master_df$rain_tmrw == "Yes", 1, 0)
master_df <- master_df[!master_df$total == 0, ]
```

```{r correlation_matrx, echo=FALSE}
corr_master_df <- subset(master_df, select = -c(1, 7, 9, 13, 14, 19, 20, 28, 30))
#corr_master_df <- subset(master_df, select = -c(1:3, 5:21, 28, 30))
ggcorr(corr_master_df, label = TRUE)
```

## Analyse

### 1. Describe the modelling procedure with enough detail to allow someone else to repeat the modelling

```{r Split dataset, echo=FALSE}
df_size <- floor(0.75 * nrow(master_df))

set.seed(123)
train_ind <- sample(seq_len(nrow(master_df)), size = df_size)

train <- master_df[train_ind, ]
test <- master_df[-train_ind, ]
```

```{r Linear Regression, echo=FALSE}
model1 <- lm(rainfall ~ min_temp + max_temp + sun_sh_hr + `9am_hum` + `9am_pres` + `3pm_temp` + `3pm_hum`, data= train)
summary(model1)

pred = predict(model1, test, method = "anova")
rmse_lm = rmse(pred, test$rainfall)
print(rmse_lm)
```
We chose two models for our prediction which are linear regression and decision tree. 
As we can see that rmse in model 1 is 2.5266, p value is 1.686e-06 which has shown that our features are useful for our prediction in the next part. 

```{r decision tree using regression, echo=FALSE}
model2 <- rpart(rainfall ~ min_temp + max_temp + sun_sh_hr + `9am_hum` + `9am_pres` + `3pm_temp` + `3pm_hum`, 
             method = "anova", data = train, control =rpart.control(minsplit =1,minbucket=1, cp=.02))
pred2 = predict(model2, test, method = "anova")
err2 = sum(pred2 - test$rainfall)
rmse_tree = rmse(pred2, test$rainfall)
summary(model1)
print(rmse_tree)
```
rmse in model2 is 3.024 which is almost the same as model1 which we can use both model for our prediction in the next part.
```{r decision tree plot, echo=FALSE}
# Plot
rpart.plot(model2, box.palette="RdBu", shadow.col="gray",uniform = TRUE,
     main = "Rainfall Decision Tree using Regression")

```





